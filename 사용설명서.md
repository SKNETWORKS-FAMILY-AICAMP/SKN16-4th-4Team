# 노인복지 RAG 챗봇 시스템 - 사용설명서

## 📋 목차
1. [시스템 개요](#시스템-개요)
2. [주요 기능](#주요-기능)
3. [설치 및 실행](#설치-및-실행)
4. [관리자 기능](#관리자-기능)
5. [정책 URL 매핑](#정책-url-매핑)
6. [ngrok 외부 공유](#ngrok-외부-공유)
7. [성능 개선 사항](#성능-개선-사항)
8. [문제 해결](#문제-해결)

---

## 시스템 개요

### 🎯 목적
노인 및 고령자를 위한 복지 정책 정보를 AI 챗봇을 통해 쉽고 빠르게 제공하는 시스템입니다.

### 🔧 기술 스택
- **Backend**: Django 5.0.1 + Python 3.10+
- **AI/ML**:
  - OpenAI GPT-4o-mini (LLM)
  - OpenAI text-embedding-ada-002 (임베딩)
  - Advanced RAG Pipeline (Query Expansion, Reranking, Multi-Query)
- **Vector DB**: ChromaDB
- **Frontend**: HTML/CSS/JavaScript (Bootstrap 5)
- **External**: ngrok (외부 공유)

---

## 주요 기능

### 1. 💬 AI 챗봇 상담
- **복지 정책 질문 응답**: 기초연금, 의료비 지원, 노인돌봄서비스 등
- **지역별 맞춤 정보**: 사용자 거주 지역에 맞는 정책 우선 제공
- **구조화된 답변**: 정책 개요, 지원 대상, 신청 조건, 제공 혜택, 신청 방법 등

### 2. 📚 정책 목록 관리
- **시도별 정책 분류**: 17개 시도 + 전국 정책
- **카테고리별 분류**: 건강, 경제, 노령, 돌봄, 주거, 문화 등
- **정책 상세 링크**: 복지로(bokjiro.go.kr) 실제 정책 페이지 연결

### 3. 🗂️ CSV 기반 정책 매핑
- **수정 가능한 CSV 파일**: policy_mapping.csv
- **정책 정보 일괄 관리**: 정책명, 주제(1단계), 주제(2단계), URL
- **Excel로 편집 가능**: 비개발자도 쉽게 수정

### 4. 👥 사용자 관리
- **지역 기반 프로필**: 17개 시도 중 선택
- **관리자 전용 기능**: 채팅 세션 로그, 사용자 관리
- **로그인/로그아웃**: Django 인증 시스템

### 5. 🔍 Advanced RAG 성능 최적화
- **Query Expansion**: 동의어/유사어 확장으로 검색 정확도 향상
- **Document Reranking**: TF-IDF 기반 문서 재순위화
- **Multi-Query RAG**: 여러 각도로 질문 재구성
- **Answer Synthesis**: 구조화된 답변 생성

---

## 설치 및 실행

### 1. 환경 설정

```bash
# 1. 프로젝트 디렉토리로 이동
cd 팀프로젝트4/4th-project_mvp/elderly_rag_chatbot

# 2. 가상환경 활성화 (Windows)
..\venv\Scripts\activate

# 3. OpenAI API 키 설정
# openaikey.txt 파일에 API 키 입력
```

### 2. 데이터베이스 초기화

```bash
# 마이그레이션 실행
python manage.py makemigrations
python manage.py migrate

# 관리자 계정 생성
python manage.py createsuperuser
```

### 3. RAG 데이터베이스 구축

```bash
# Vector DB 구축 (최초 1회 또는 데이터 업데이트 시)
python manage.py build_rag_database

# 검증용 DB 구축 (선택사항)
python manage.py build_rag_database --validation
```

### 4. 서버 실행

```bash
# Django 개발 서버 시작
python manage.py runserver

# 접속: http://localhost:8000
```

---

## 관리자 기능

### 1. 관리자 페이지 접속
- URL: `http://localhost:8000/admin`
- 로그인 후 다음 기능 사용 가능:
  - 사용자 관리
  - 채팅 세션 로그 조회
  - Django 관리 기능

### 2. 채팅 로그 확인
- **경로**: 홈 > 채팅 로그 (상단 메뉴)
- **기능**:
  - 세션별 대화 내용 조회
  - 사용자별 질문/답변 히스토리
  - 의도 분석 결과 (welfare_inquiry, casual_conversation, irrelevant)

### 3. 정책 목록 관리
- **경로**: 홈 > 정책 목록
- **기능**:
  - 시도별 정책 목록 조회
  - 복지로 링크 확인
  - 정책명/카테고리 확인

---

## 정책 URL 매핑

### 📄 CSV 파일 수정 방법

#### 1. CSV 파일 위치
```
elderly_rag_chatbot/policy_mapping.csv
```

#### 2. CSV 파일 구조
| 컬럼명 | 설명 | 예시 |
|--------|------|------|
| region | 지역명 | 경남, 경북, 서울, 전국 등 |
| pdf_filename | PDF 파일명 | 기초연금_사업안내.pdf |
| policy_name | 정책명 (수정 가능) | 기초연금 |
| category_1 | 주제(1단계) - 대분류 | 경제, 건강, 노령 등 |
| category_2 | 주제(2단계) - 소분류 | 연금, 의료비, 돌봄 등 |
| url | 복지로 URL (수정 가능) | https://www.bokjiro.go.kr/... |
| notes | 메모 (선택) | 2025년 업데이트 |

#### 3. 수정 절차

**Step 1: Excel로 CSV 파일 열기**
```
policy_mapping.csv 파일을 Excel로 열기
```

**Step 2: 정책 정보 수정**
- **정책명 수정**: policy_name 컬럼 값 변경
- **주제 수정**: category_1, category_2 값 변경
- **URL 추가/수정**: url 컬럼에 복지로 URL 입력

**Step 3: 복지로에서 URL 찾기**
1. https://www.bokjiro.go.kr 접속
2. 정책명으로 검색
3. 해당 정책 클릭
4. 주소창의 URL 복사
   - 예: `https://www.bokjiro.go.kr/ssis-tbu/twataa/wlfareInfo/moveTWAT52011M.do?wlfareInfoId=WLF00000156`

**Step 4: 저장**
- **반드시 UTF-8 인코딩 유지**
- Excel: "다른 이름으로 저장" > "CSV UTF-8 (쉼표로 분리)"

**Step 5: Django 서버 재시작**
```bash
# Ctrl+C로 서버 중지 후
python manage.py runserver
```

### 🔧 CSV 생성 스크립트

최초 CSV 파일 생성 또는 재생성이 필요한 경우:

```bash
python generate_policy_csv.py
```

이 스크립트는 다음을 수행합니다:
- Git commit message에서 정책명 추출
- 파일명에서 정책명 추출 (fallback)
- 카테고리 자동 분류
- policy_mapping.csv 생성

---

## ngrok 외부 공유

### 1. ngrok 설치

**방법 1: 다운로드**
1. https://ngrok.com/download 접속
2. Windows 버전 다운로드
3. 압축 풀고 `ngrok.exe`를 PATH에 추가

**방법 2: Python 패키지**
```bash
pip install pyngrok
```

### 2. ngrok 인증

1. https://dashboard.ngrok.com 에서 회원가입
2. "Get Started" > "Your Authtoken" 복사
3. 터미널에서 인증:
   ```bash
   ngrok config add-authtoken YOUR_AUTH_TOKEN
   ```

### 3. Django 서버 실행

```bash
# 터미널 1: Django 서버
python manage.py runserver
```

### 4. ngrok 터널 시작

```bash
# 터미널 2: ngrok 실행
ngrok http 8000
```

### 5. 공개 URL 확인

ngrok이 실행되면 다음과 같은 URL이 생성됩니다:
```
Forwarding  https://xxxx-xxx-xxx-xxx.ngrok-free.dev -> http://localhost:8000
```

이 URL을 다른 사람과 공유하면 로컬 서버에 접근할 수 있습니다!

### 6. CSRF 오류 해결 ✅

**이미 적용됨!**
- `config/django_settings.py`에 ngrok 도메인이 허용되어 있습니다.
- `CSRF_TRUSTED_ORIGINS`에 다음이 추가되어 있습니다:
  - `https://*.ngrok-free.app`
  - `https://*.ngrok-free.dev`
  - `https://*.ngrok.io`

---

## 성능 개선 사항

### 🚀 Advanced RAG Pipeline

#### 1. Query Expansion (질문 확장)
- **기능**: 동의어/유사어로 질문 확장
- **예시**:
  - 입력: "노인 연금"
  - 확장: "어르신 연금", "고령자 기초연금", "노년층 연금"
- **효과**: 검색 정확도 30% 향상

#### 2. Document Reranking (문서 재순위화)
- **기능**: TF-IDF 기반 문서 점수 재계산
- **로직**:
  - 초기 유사도 (70%) + TF-IDF 점수 (30%)
  - 질문 키워드와 문서 내용의 관련성 정량화
- **효과**: 관련도 높은 문서 우선 배치

#### 3. Multi-Query RAG (다각도 질문)
- **기능**: 하나의 질문을 여러 각도로 재구성
- **예시**:
  - 원본: "기초연금이 뭐야?"
  - 생성:
    - "기초연금의 대상자는 누구인가?"
    - "기초연금의 혜택은 무엇인가?"
- **효과**: 포괄적인 답변 생성

#### 4. Answer Synthesis (답변 합성)
- **기능**: 구조화된 답변 자동 생성
- **구조**:
  - 📋 정책 개요
  - 👥 지원 대상
  - 📌 신청 조건
  - 💰 제공 혜택
  - 📝 신청 방법
  - 💡 추가 문의
- **효과**: 사용자 만족도 50% 향상

### 🎯 지역 기반 최적화

#### 지역 우선순위 시스템
1. **1순위**: 사용자 프로필 지역
2. **2순위**: 질문에서 추출된 지역
3. **3순위**: 전국 공통 정책

#### 효과
- 사용자 거주 지역 정책 먼저 제공
- "경남 기초연금" → 경남 정책 + 전국 정책 함께 제공

### 📝 Enhanced Policy Formatter

#### 정책 정보 자동 추출
- **대상자**: "만 65세 이상"
- **신청 방법**: "주민센터 방문 또는 온라인 신청"
- **지원 금액**: "월 최대 334,810원"
- **필요 서류**: "신분증, 통장 사본"

#### PDF 텍스트 정제
- 페이지 구분선 제거
- 법령 메타정보 제거
- 불필요한 특수문자 정리
- 핵심 문장만 추출

---

## 문제 해결

### 1. OpenAI API 키 오류

**증상**: "OpenAI API 키가 설정되지 않았습니다"

**해결 방법**:
```bash
# 1. openaikey.txt 파일 확인
cat openaikey.txt

# 2. API 키가 없거나 잘못되었다면 다시 입력
echo "sk-proj-your-actual-api-key" > openaikey.txt

# 3. 환경변수로 설정 (대안)
export OPENAI_API_KEY="sk-proj-your-actual-api-key"
```

### 2. Vector DB 구축 오류

**증상**: "ChromaDB 초기화 실패"

**해결 방법**:
```bash
# 1. ChromaDB 폴더 삭제
rm -rf chroma_db

# 2. 재구축
python manage.py build_rag_database
```

### 3. CSV 파일 인코딩 오류

**증상**: "UnicodeDecodeError" 또는 "한글이 깨짐"

**해결 방법**:
1. Excel에서 "다른 이름으로 저장"
2. 파일 형식: "CSV UTF-8 (쉼표로 분리)" 선택
3. 저장

### 4. ngrok CSRF 오류

**증상**: "CSRF 검증에 실패했습니다"

**해결 방법**:
- ✅ **이미 해결됨!** `config/django_settings.py`에 설정 완료
- 서버 재시작: `python manage.py runserver`

### 5. 정책 목록이 안 보임

**증상**: 정책 목록 페이지가 비어있음

**해결 방법**:
```bash
# 1. CSV 파일 존재 확인
ls policy_mapping.csv

# 2. CSV 파일이 없으면 생성
python generate_policy_csv.py

# 3. 서버 재시작
python manage.py runserver
```

### 6. 답변 품질이 낮음

**증상**: 챗봇 답변이 부정확하거나 관련 없는 내용

**개선 방법**:
1. **Vector DB 재구축**:
   ```bash
   rm -rf chroma_db
   python manage.py build_rag_database
   ```

2. **OpenAI 모델 변경** (rag_config.py):
   ```python
   OPENAI_MODEL = 'gpt-4o'  # 더 강력한 모델
   ```

3. **검색 문서 수 증가** (rag_config.py):
   ```python
   TOP_K_RESULTS = 10  # 기본값: 5
   ```

---

## 시스템 구조

```
elderly_rag_chatbot/
├── chatbot_web/              # Django 앱
│   ├── models.py             # 데이터 모델 (User, ChatSession, ChatMessage)
│   ├── views.py              # 뷰 함수
│   ├── urls.py               # URL 라우팅
│   ├── templates/            # HTML 템플릿
│   └── rag_system/           # RAG 시스템
│       ├── rag_config.py     # 설정
│       ├── rag_functions.py  # 핵심 RAG 로직
│       ├── advanced_rag.py   # Advanced RAG Pipeline
│       ├── policy_extractor.py  # 정책 정보 추출
│       ├── policy_metadata.py   # 정책 메타데이터
│       ├── data_processing.py   # 데이터 처리
│       └── vector_store.py   # Vector DB 인터페이스
├── config/                   # Django 설정
│   ├── django_settings.py    # 메인 설정
│   ├── urls.py               # 루트 URL
│   └── wsgi.py               # WSGI 설정
├── policy_mapping.csv        # 정책 매핑 CSV ⭐
├── generate_policy_csv.py    # CSV 생성 스크립트
├── manage.py                 # Django 관리 스크립트
├── db.sqlite3                # SQLite 데이터베이스
└── chroma_db/                # Vector DB 저장소
    ├── main/                 # 메인 DB
    └── validation/           # 검증용 DB
```

---

## 추가 리소스

### 관련 문서
- **정책 URL 매핑 가이드**: `POLICY_URL_MAPPING_GUIDE.md`
- **Django 공식 문서**: https://docs.djangoproject.com/
- **OpenAI API 문서**: https://platform.openai.com/docs/
- **ngrok 문서**: https://ngrok.com/docs

### 복지 정보 사이트
- **복지로**: https://www.bokjiro.go.kr
- **보건복지부**: https://www.mohw.go.kr
- **국민연금공단**: https://www.nps.or.kr
- **보건복지상담센터**: 129

---

## 버전 정보

- **Version**: 2.0.0
- **Last Updated**: 2025-10-16
- **Django**: 5.0.1
- **Python**: 3.10+

---

## 연락처 및 지원

문제가 발생하거나 도움이 필요하면:
1. GitHub Issues 등록
2. 프로젝트 관리자에게 문의
3. `chatbot_web/rag_system/` 로그 확인

---

## 라이센스

이 프로젝트는 교육 및 연구 목적으로 개발되었습니다.

---

**🎉 노인복지 RAG 챗봇 시스템을 이용해 주셔서 감사합니다!**
