{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-gear-fill"></i> {{ config.name }}</h2>
    <div>
        <a href="{% url 'chatbot_web:validation_config_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 목록
        </a>
        {% if user.is_staff %}
        <a href="{% url 'chatbot_web:validation_config_edit' config.pk %}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> 수정
        </a>
        {% if config.build_status != 'building' %}
        <a href="{% url 'chatbot_web:validation_config_build' config.pk %}" class="btn btn-success" title="이 구성으로 DB 초기화 후 문서 처리">
            <i class="bi bi-arrow-repeat"></i>
            {% if config.build_status == 'completed' %}재구축{% else %}구축 시작{% endif %}
        </a>
        {% endif %}
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header {% if config.is_active %}bg-success text-white{% else %}bg-secondary text-white{% endif %}">
                <h5 class="mb-0">
                    구성 정보
                    {% if config.is_active %}
                    <span class="badge bg-light text-success float-end"><i class="bi bi-check-circle"></i> 활성</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <p><strong>설명:</strong> {{ config.description|default:"설명 없음" }}</p>

                <hr>

                <h6><i class="bi bi-file-earmark-text"></i> 텍스트 추출기</h6>
                <p>
                    <strong>PDF:</strong> <span class="badge bg-primary">{{ config.get_pdf_extractor_display }}</span> <code>({{ config.pdf_extractor }})</code><br>
                    <strong>HWP:</strong> <span class="badge bg-success">{{ config.get_hwp_extractor_display }}</span> <code>({{ config.hwp_extractor }})</code><br>
                    <strong>OCR:</strong>
                    {% if config.use_ocr %}
                    <span class="badge bg-info">사용 (PDF 실패 시)</span>
                    {% else %}
                    <span class="badge bg-secondary">미사용</span>
                    {% endif %}
                </p>

                <h6><i class="bi bi-scissors"></i> 청킹 전략</h6>
                <p>
                    <span class="badge bg-success">{{ config.get_chunking_strategy_display }}</span> <code>({{ config.chunking_strategy }})</code><br>
                    <small>청크 크기: {{ config.chunk_size }} | 오버랩: {{ config.chunk_overlap }}</small>
                </p>

                <h6><i class="bi bi-cpu"></i> 임베딩 모델</h6>
                <p><span class="badge bg-info text-dark">{{ config.embedding_model }}</span></p>

                <h6><i class="bi bi-search"></i> 검색 전략</h6>
                <p>
                    <span class="badge bg-warning text-dark">{{ config.get_retrieval_strategy_display }}</span> <code>({{ config.retrieval_strategy }})</code><br>
                    <small>Top-K: {{ config.top_k }}개</small>
                </p>

                <hr>

                <h6><i class="bi bi-database"></i> ChromaDB 정보</h6>
                <p>
                    <strong>컬렉션명:</strong> <code>{{ config.collection_name }}</code><br>
                    {% if config.total_documents %}
                    <strong>총 문서 수:</strong> {{ config.total_documents }}개<br>
                    <strong>총 청크 수:</strong> {{ config.total_chunks }}개
                    {% endif %}
                </p>

                <hr>

                <h6><i class="bi bi-calendar"></i> 타임라인</h6>
                <ul class="small">
                    <li><strong>생성:</strong> {{ config.created_at|date:"Y-m-d H:i:s" }} ({{ config.created_by.username }})</li>
                    {% if config.build_started_at %}
                    <li><strong>구축 시작:</strong> {{ config.build_started_at|date:"Y-m-d H:i:s" }}</li>
                    {% endif %}
                    {% if config.build_completed_at %}
                    <li><strong>구축 완료:</strong> {{ config.build_completed_at|date:"Y-m-d H:i:s" }}</li>
                    {% endif %}
                    <li><strong>마지막 수정:</strong> {{ config.updated_at|date:"Y-m-d H:i:s" }}</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-activity"></i> 구축 상태
            </div>
            <div class="card-body text-center">
                {% if config.build_status == 'pending' %}
                <i class="bi bi-clock display-1 text-secondary"></i>
                <h5 class="mt-3">대기중</h5>
                <p class="text-muted">아직 구축되지 않았습니다</p>
                {% elif config.build_status == 'building' %}
                <div class="spinner-border text-warning" style="width: 5rem; height: 5rem;" role="status"></div>
                <h5 class="mt-3">구축 진행중</h5>
                <p class="text-muted">잠시만 기다려주세요...</p>
                {% elif config.build_status == 'completed' %}
                <i class="bi bi-check-circle display-1 text-success"></i>
                <h5 class="mt-3">구축 완료</h5>
                <p class="text-muted">사용 준비 완료</p>
                {% elif config.build_status == 'failed' %}
                <i class="bi bi-x-circle display-1 text-danger"></i>
                <h5 class="mt-3">구축 실패</h5>
                <p class="text-muted">다시 시도해주세요</p>
                {% endif %}
            </div>
        </div>

        {% if config.build_status == 'completed' %}
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="bi bi-chat-dots"></i> 챗봇 테스트
            </div>
            <div class="card-body">
                <p class="small">이 구성으로 챗봇을 테스트하세요</p>
                <a href="{% url 'chatbot_web:validation_chat' %}" class="btn btn-success w-100">
                    <i class="bi bi-play-circle"></i> 챗봇 시작
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if config.error_message %}
<div class="alert alert-danger">
    <h5><i class="bi bi-exclamation-triangle"></i> 오류 메시지</h5>
    <pre class="mb-0">{{ config.error_message }}</pre>
</div>
{% endif %}
{% endblock %}
